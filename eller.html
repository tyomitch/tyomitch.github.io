<html><head><title>Eller's Maze Generator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.js"></script>
</head><body>

<canvas width="320" height="178"></canvas>

<script>
const canvas = $('canvas').get()[0];
const context = canvas.getContext('2d');
context.fillStyle = 'black';
context.fillRect(0, 0, 320, 178);

const width = 18;

function prrow(seed, frame, nextgen) {
    if (frame)
        setTimeout(prrow, 40, seed, frame-1, nextgen);
    else
        setTimeout(nextgen, 40);
    context.drawImage(canvas, 0, -1);
    context.fillStyle = 'black';
    context.fillRect(0, 177, 320, 1);
    context.fillStyle = 'rgb(190,173,81)';
    for (let i=1; i<=width; i++) {
      if (seed & 1)
        context.fillRect(16*i, 177, 16, 1);
      seed >>= 1;
    }
    context.fillRect(0, 177, 16, 1);
    context.fillRect(304, 177, 32, 1);
}

// initialize

let counter = 0;
let sets = {};
let cells = [];
for (let col=0; col < width; col++) {
    sets[++counter] = [col];
    cells[col] = counter;
}
let verticals = [];

rowgen1();

function rowgen1() {
    function merge(a, b) {
        let id_a = cells[a];
        let id_b = cells[b];
        if (id_a == id_b)
            return;

        sets[id_a] = sets[id_a].concat(sets[id_b]);
        for (let b of sets[id_b])
            cells[b] = id_a;
        delete sets[id_b];
    }

    let seed = 0;
    for (let col = 0; col < width-2; col++) {
        seed <<= 1;
        if ((cells[col] != cells[col+2]) && (Math.random() < 0.5) && (verticals.indexOf(col+3) == -1)) {
            merge(col, col+1);
            merge(col+1, col+2);
        } else if ([(verticals.indexOf(col) > -1) && (verticals.indexOf(col+2) > -1), verticals.indexOf(col+1) == -1][+(cells[col] != cells[col+2])]) {
            seed |= 1;
            seed <<= 1;
            col++;
            let id = cells[col];
            cells[col] = 0;
            sets[id] = sets[id].filter(c => c != col);
            if (!sets[id].length)
                delete sets[id];
        }
        if (col == width-3)
            seed <<= 1;
    }
    for (let col = 0; col < width-1; col++)
        if (cells[col] && cells[col+1] && (cells[col] != cells[col+1]))
            merge(col, col+1);
    prrow(seed, 16, rowgen2);
}

function rowgen2() {
    verticals = [];
    for (let id in sets) {
        let set = sets[id];
        let count = 1 + Math.random() * (set.length - 1);
        set = _.shuffle(set).slice(0, count);
        verticals = verticals.concat(set);
        sets[id] = set;
    }
    let seed = 0;
    for (let col = 0; col < width; col++) {
        seed <<= 1;
        if (verticals.indexOf(col) == -1) {
            sets[++counter] = [col];
            cells[col] = counter;
            seed |= 1;
        }
    }
    prrow(seed, 16, rowgen1);
}

</script>

</body></html>